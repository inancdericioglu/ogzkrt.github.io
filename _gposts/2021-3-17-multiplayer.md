---
layout: post
title: Multiplayer Game with Java LibGDX and Kryonet
---

This posts explains how to develop Multiplayer game with Java by using LibGDX and Kryonet. If you able bear until the end of this post and follow all the steps, your final product will be something like this:


<p align="center">
<img src="/images/multiplayer/killthemall.gif" alt="Game Play GIF" width="1000">
</p>

The game that we are going to develop will be Desktop Game and you will able to run it on Windows Linux MacOS.

### Note

Each section of this post has also have tutorial video on youtube. If you like this post please Subscribe to my channel.

## Table of Contents

* [Setup Installation](#installation)
* [Project Layout](#project-layout)
* [Authorative Server Approach](#authorative-server-approach)
* [State Structure](#state-mechanism)
* [Play State](#play-state)
* [Menu State](#menu-state)
* [Game Over State](#architecture)
* [Font Rendering](#font-rendering)
* [Basic Connection with Server](#basic-connection-with-server)
* [Creating Player](#creating-player)
* [Input Processing](#input-processing)
* [Server-side Enemy Generation](#server-side-enemy-generation)
* [Sending Inputs to the Server](#sending-inputs-to-the-server)
* [Rendering Other Players](#rendering-other-players)
* [Shooting](#shooting)
* [Collision Detection](#collision-detection)
* [Conclusion](#conclusion)


## Installation

We will be using LibGDX framework. LibGDX is a cross-platform open source Java game development framework.
You should download **gdx-setup_latest.jar** from libGDX official [website](https://libgdx.com/dev/project-generation/). Then run that jar file, after running you supposed to see GUI called LibGDX Project Generator.

<p align="center">
<img src="/images/multiplayer/setup.jpg" alt="LibGDX Project Generator" width="500">
</p>
Fill the following fields.
- Name 
- Package
- Destination

As you can see, project generator ask us about the **Android SDK** location because LibGDX will also generate android project for us. Since our game will support only Desktop, uncheck the checkboxes other than **Desktop** in Sub Projects section.


Also make sure you checked the Freetype which will be used to draw fonts, from the extensions section in Project Generator.

After filling necessary fields push the generate button and wait few seconds. You should be seeing **BUILD SUCCESSFUL** log.

<p align="center">
<img src="/images/multiplayer/generated.png" alt="LibGDX Project Generator" width="500">
</p>

Now, we can import the project generated by setup app to our IDE. I will be using Eclipse during these tutorials (because I'm comfortable with it) but you can use whatever IDE you want as long as it supports **Gradle Projects**.

Do the following steps for importing project to the Eclipse

- From **File** menu, Choose the **Import** menuitem.
- From the dialog Choose **Gradle** -> **Existing Gradle Project** (If you don't have Gradle section in this dialog, install Gradle Plugin from MarketPlace
- Browse the folder that you have generated with setup app and press the **Finish** button.

Now, you should have three different project in your project explorer on the left if you are also using Eclipse like me. From Desktop project, choose the DesktopLauncher.java and run it. If you see a window pop out on your screen like this, it means you are good to go.

<p align="center">
<img src="/images/multiplayer/after_inst.png" alt="Game Window" width="1000">
</p>

If you prefer to watch or having problem during the installation, you can also watch the [tutorial]() video that I made. 

## Project Layout

Project that we have generated with setup app has folder structure like this. Projects root folder has three sub folders which are:
- core (this is the folder where we are going to write our code)
- desktop (this folder has Desktop project)
- gradle 

``` bash
├── core
│   ├── assets
│   └── src
│       └── com
│           └── javakaian
│               └── game
├── desktop
│   └── src
│       └── com
│           └── javakaian
│               └── game
│                   └── desktop
└── gradle
    └── wrapper
```

Instead of core and desktop folders, I want **Client** and **Server** folders inside the root directory.
- Cliend (Our client code will be here)
- Server (Our server side code will be here).





Do the following things to step by step.

- Add following lines to the **.gitignore** file.
```text
/client/bin/
/server/bin/
```

- Remove the project **core** and **desktop** inside build.gradle file inside the root folder and paste the following projects instead of them.
```gradle
project(":client") {
    apply plugin: "java-library"


    dependencies {
    	api "com.badlogicgames.gdx:gdx-backend-lwjgl:$gdxVersion"
        api "com.badlogicgames.gdx:gdx-platform:$gdxVersion:natives-desktop"
        api "com.badlogicgames.gdx:gdx-box2d-platform:$gdxVersion:natives-desktop"
        api "com.badlogicgames.gdx:gdx-freetype-platform:$gdxVersion:natives-desktop"
        api "com.badlogicgames.gdx:gdx:$gdxVersion"
        api "com.badlogicgames.gdx:gdx-box2d:$gdxVersion"
        api "com.badlogicgames.gdx:gdx-freetype:$gdxVersion"
        compile "com.esotericsoftware:kryonet:2.22.0-RC1"
        
    }
}
project(":server") {
    apply plugin: "java-library"


    dependencies {
     	api "com.badlogicgames.gdx:gdx-backend-lwjgl:$gdxVersion"
     	api "com.badlogicgames.gdx:gdx-backend-headless:$gdxVersion"
        api "com.badlogicgames.gdx:gdx-platform:$gdxVersion:natives-desktop"
        api "com.badlogicgames.gdx:gdx:$gdxVersion"
        api "com.badlogicgames.gdx:gdx-box2d:$gdxVersion"
        api "com.badlogicgames.gdx:gdx-freetype:$gdxVersion"
        compile "com.esotericsoftware:kryonet:2.22.0-RC1"
        
    }
}
```

- Delete the desktop folder
- Rename the **core** folder to the **client**
- Copy **client** folder and rename it as **server**
- Open the **settings.gradle** replace its content with 
```bash
include 'client','server'
```
- Browse the **build.gradle** file inside the **client**  folder and replace it's content with this.
```bash
sourceCompatibility = 1.8
[compileJava, compileTestJava]*.options*.encoding = 'UTF-8'
sourceSets.main.java.srcDirs = [ "src/" ]
project.ext.assetDir = new File("./assets")
sourceSets.main.resources.srcDirs = ["./assets"]
eclipse.project.name = appName + "-client"
```

- Browse the **build.gradle** file inside the **server**  folder and it's replace content with this.
```bash
sourceCompatibility = 1.8
[compileJava, compileTestJava]*.options*.encoding = 'UTF-8'
sourceSets.main.java.srcDirs = [ "src/" ]
eclipse.project.name = appName + "-server"
```

- Inside the **Killthemall-server** project rename the **Killthemall.java** to **KillthemallServer.java** and replace its content with this.

```java

package com.javakaian.game;
import com.badlogic.gdx.ApplicationAdapter;

public class KillthemallServer extends ApplicationAdapter {

	@Override
	public void create() {
		System.out.println("Server created..");
	}

	@Override
	public void render() {
	}

}

```

- Create a main class for server. Since our server does not need GUI, we will be using HeadlessApplication.

```java

package com.javakaian.game;

import com.badlogic.gdx.backends.headless.HeadlessApplication;
import com.badlogic.gdx.backends.headless.HeadlessApplicationConfiguration;

public class ServerMain {

	public static void main(String[] args) {

		HeadlessApplicationConfiguration conf = new HeadlessApplicationConfiguration();
		conf.updatesPerSecond = 60;

		new HeadlessApplication(new KillthemallServer(), conf);
	}

}
```
Now we will do the same things for client.
- Inside the **Killthemall-client** project rename the **Killthemall.java** to **KillthemallClient.java** and replace its content with this.

```java
package com.javakaian.game;

import com.badlogic.gdx.ApplicationAdapter;
import com.badlogic.gdx.graphics.Texture;
import com.badlogic.gdx.graphics.g2d.SpriteBatch;
import com.badlogic.gdx.utils.ScreenUtils;

public class KillthemallClient extends ApplicationAdapter {
	SpriteBatch batch;
	Texture img;
	
	@Override
	public void create () {
		batch = new SpriteBatch();
		img = new Texture("badlogic.jpg");
	}

	@Override
	public void render () {
		ScreenUtils.clear(1, 0, 0, 1);
		batch.begin();
		batch.draw(img, 0, 0);
		batch.end();
	}
	
	@Override
	public void dispose () {
		batch.dispose();
		img.dispose();
	}
}


```

- Create a main class for client.

```java
package com.javakaian.game;

import com.badlogic.gdx.backends.lwjgl.LwjglApplication;
import com.badlogic.gdx.backends.lwjgl.LwjglApplicationConfiguration;

public class ClientMain {

	public static void main(String[] args) {

		LwjglApplicationConfiguration conf = new LwjglApplicationConfiguration();

		new LwjglApplication(new KillthemallClient(), conf);

	}
}

```
That's it. Now we are done with our second tutorial. If you have an error or struggle to do steps above, you can watch my video tutorial from [this]()
link. If you find this usefull please subsrice to my youtube channel.

## Authorative Server Approach

Our game will follow authorative server and dumb clients approach. Basically it means, whenever a client wants to do an action it will send it to the server and server will check the validity of that action and respond back to client with a new state. For more in depth explanation please read [this](https://www.gabrielgambetta.com/client-server-game-architecture.html#authoritative-servers-and-dumb-clients) explanation.

<p align="center">
<img src="/images/multiplayer/server_client.png" alt="Server Client Arc" width="1000">
Client Server Architecture
</p>


As you can see from the figure above, we will have one server which will manage multiple clients. 

## State Mechanism
## Play State
## Menu State
## Game Over State
## Font Rendering
## Basic Connection with Server
## Creating Player
## Input Processing
## Server-side Enemy Generation
## Sending Inputs to the Server
## Rendering Other Players
## Shooting
## Collision Detection



## Conclusion

This was my first Multiplayer Game, even though it was so simple I learned a lot during the journay.
This project still lacks of features like 
- **Client-Side Prediction**, 
- **Server Reconciliation**,
- **Entity Interpolation**.
 
If you like to know more about these topics please read the awesome blog of Gabriel Gambetta [here](https://www.gabrielgambetta.com/client-server-game-architecture.html)